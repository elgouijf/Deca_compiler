name: CI Deca GL

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  tests-basic:
    runs-on: ubuntu-latest
    container:
      image: gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest
      options: --user root
      credentials:
        username: ${{ secrets.ENSIMAG_USER }}
        password: ${{ secrets.ENSIMAG_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
      - name: Run basic tests
        run: mvn -q -e test

  tests-lex:
    runs-on: ubuntu-latest
    container:
      image: gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest
      options: --user root
      credentials:
        username: ${{ secrets.ENSIMAG_USER }}
        password: ${{ secrets.ENSIMAG_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
      - name: Lexical tests
        run: |
          mvn -q -DskipTests test-compile dependency:build-classpath
          ./src/test/script/test_lex_energy.sh
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-lex
          path: src/test/script/report

  tests-synt:
    runs-on: ubuntu-latest
    container:
      image: gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest
      options: --user root
      credentials:
        username: ${{ secrets.ENSIMAG_USER }}
        password: ${{ secrets.ENSIMAG_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
      - name: Syntax tests
        run: |
          mvn -q -DskipTests test-compile dependency:build-classpath
          ./src/test/script/test_syntax_energy.sh
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-syntax
          path: src/test/script/report

  tests-context:
    runs-on: ubuntu-latest
    container:
      image: gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest
      options: --user root
      credentials:
        username: ${{ secrets.ENSIMAG_USER }}
        password: ${{ secrets.ENSIMAG_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
      - name: Context tests
        run: |
          mvn -q -DskipTests test-compile dependency:build-classpath
          ./src/test/script/test_context_energy.sh
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-context
          path: src/test/script/report

  tests-codegen:
    runs-on: ubuntu-latest
    container:
      image: gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest
      options: --user root
      credentials:
        username: ${{ secrets.ENSIMAG_USER }}
        password: ${{ secrets.ENSIMAG_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
      - name: Codegen tests
        run: |
          mvn -q -DskipTests test-compile dependency:build-classpath
          ./src/test/script/test_gencode_energy.sh
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-codegen
          path: src/test/script/report

  tests-differential:
    runs-on: ubuntu-latest
    container:
      image: gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest
      options: --user root
      credentials:
        username: ${{ secrets.ENSIMAG_USER }}
        password: ${{ secrets.ENSIMAG_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
      - name: Differential tests
        run: |
          mvn -q -DskipTests test-compile dependency:build-classpath
          ./src/test/script/test_differential_energy.sh
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-differential
          path: src/test/script/report

  pages:
    runs-on: ubuntu-latest
    needs: [tests-lex, tests-synt, tests-context, tests-codegen, tests-differential]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports
      - name: Build Index
        run: |
          mkdir -p public
          find all-reports -name "*.svg" -exec cp {} public/ \; || true
          echo "<html><body><h1>RÃ©sultats des tests</h1>" > public/index.html
          for img in public/*.svg; do
            img_name=$(basename "$img")
            echo "<img src=\"$img_name\" alt=\"$img_name\" /><br>" >> public/index.html
          done
          echo "</body></html>" >> public/index.html
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public