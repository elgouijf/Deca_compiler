name: CI Deca GL Performance

on:
  push:
  pull_request:

jobs:
  # ==========================================
  # ÉTAPE 1 : Compilation unique (Gain de temps)
  # ==========================================
  build-project:
    runs-on: ubuntu-latest
    container: 
      image: gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest
    steps:
      - uses: actions/checkout@v4
      - name: Compile
        run: mvn -q clean test-compile
      # On sauvegarde le dossier target pour les jobs suivants
      - name: Cache target
        uses: actions/upload-artifact@v4
        with:
          name: compiled-project
          path: .

  # ==========================================
  # ÉTAPE 2 : Tests en parallèle
  # ==========================================

  tests-lex:
    needs: build-project
    runs-on: ubuntu-latest
    container: { image: "gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest" }
    steps:
      - uses: actions/download-artifact@v4
        with: { name: compiled-project }
      - name: Lexical tests
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
          mvn -q dependency:build-classpath
          ./src/test/script/test_lex_energy.sh
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with: { name: report-lex, path: src/test/script/report }

  tests-synt:
    needs: build-project
    runs-on: ubuntu-latest
    container: { image: "gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest" }
    steps:
      - uses: actions/download-artifact@v4
        with: { name: compiled-project }
      - name: Syntax tests
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
          mvn -q dependency:build-classpath
          ./src/test/script/test_syntax_energy.sh
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with: { name: report-syntax, path: src/test/script/report }

  tests-codegen:
    needs: build-project
    runs-on: ubuntu-latest
    container: { image: "gitlab.ensimag.fr:5050/gl2026/gr8/gl43/deca-maven-ima:latest" }
    steps:
      - uses: actions/download-artifact@v4
        with: { name: compiled-project }
      - name: Codegen tests
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          cp tools/ima /usr/local/bin/ima && chmod +x /usr/local/bin/ima
          mvn -q dependency:build-classpath
          ./src/test/script/test_gencode_energy.sh
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with: { name: report-codegen, path: src/test/script/report }

  # ==========================================
  # ÉTAPE 3 : Déploiement Pages
  # ==========================================
  pages:
    needs: [tests-lex, tests-synt, tests-codegen]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { path: public }
      - name: Generate Index
        run: |
          # Ton script de génération d'index.html ici
          echo "<html><body><h1>Tests</h1>" > public/index.html
          find public -name "*.svg" -exec bash -c 'cp {} public/ && echo "<img src=\"$(basename {})\" /><br>" >> public/index.html' \;
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public